% 三角形三色問題の概要（数学）
\section{Coqにおける三角形三色問題}

% 4.1 三角形三色問題の証明の Coq の実装(=>)
\subsection{十分条件}
補題\ref{lem:tri_suf}をCoqに実装するために論理式の形にしたものが次の定理\ref{thm:tri_suf}である．
\begin{thm}[十分条件] \label{thm:tri_suf}
  $\forall k, n, x, y \in \N, c_0 c_1 c_2 \in \Color, n = 3 ^ k \Imp \WCT(x,y,n,c_0,c_1,c_2)$.
\end{thm}
\begin{proof}
  $k$に関する数学的帰納法を用いて証明する．
  $k=0$のときは$n=1$となるので明らかに成立する．
  次に$k$のとき成立すると仮定して$k+1$のときも成立することを示す．
  公理\ref{axm:exists}より図\ref{fig:suf_steps}における$10$色の$c^x_y$が存在する．
  以降，それぞれのマスに存在する色を図\ref{fig:suf_steps}のように名前をつけておく．
  \begin{figure}[h]
    \centering
    \input{suf_steps}
    \caption{三色三角形（$n=3^{k+1}$のとき）}
    \label{fig:suf_steps}
  \end{figure} 
  次に$6$個の$3^k$段の調和三角形三角形があることを示す．
  これは$k$に関する数学的帰納法の仮定からすぐに証明できる．
  すると，ここまでに証明した$10$個の$\Cpos$に関する命題と$6$個の$3^k$段の調和三角形三角形に関する命題から$c_2 = \mix(\mix(\mix(c_0,c_3),\mix(c_3,c_4)),$ $\mix(\mix(c_3,c_4),\mix(c_4,c_1)))$が導け，$\mixCut$より$c_2=\mix(c_0,c_1)$が成立する．
\end{proof}

% 4.2 三角形三色問題の証明の Coq の実装(<=)
% n が偶数の場合，n が奇数で短い場合，n が奇数で長い場合
% $n$が偶数のとき
% $n$が奇数 かつ $3^{k'} < n \leq 2 \cdot 3^{k}$のとき
% $n$が奇数 かつ $2 \cdot 3^{k'} + 1 \leq n < 3^{k+1}$のとき

\subsection{必要条件}
補題\ref{lem:tri_nec}をCoqに実装するために論理式の形にしたものが次の定理\ref{thm:tri_nec}である．
\begin{thm}[必要条件] \label{thm:tri_nec}
  $\forall k, n, x, y \in \N,$ $c_0 c_1 c_2 \in \Color, $ \\
  $\WCT(x,y,n,c_0,c_1,c_2) \Imp n = 3 ^ k$.
\end{thm}
次の補題\ref{lem:tri_nec'}を証明することで示す．
\begin{lem}[必要条件の対偶] \label{lem:tri_nec'}
  $\forall n, x, y \in \N,$ $n > 0$ $\Imp$ 
  $\lnot(\exists k \in \N, n = 3 ^ k)$ $\Imp$
  $\lnot( \forall c \in \Color,$
  $\forall f:\N$ $\to$ $\Color,$
  $\WCT(x,y,n,f(x),f(x+n),c)$.
\end{lem}
補題\ref{lem:tri_nec'}を証明するためには
\begin{itemize}
\item
  $n > 0$
\item
  $\lnot(\exists k \in \N, n = 3 ^ k)$，
\item
  $\forall c \in \Color,$ $\forall f:\N$ $\to$ $\Color,$ \\
  $\WCT(x,y,n,f(x),f(x+n),c)$
\end{itemize}
を仮定して矛盾を示せばよい．
また，矛盾を示す際には$n$に関する場合分けをおこなって$3$つの小小節に分けて証明する．
\subsubsection{$n$が偶数}
$n$が偶数のときは補題\ref{lem:evenA},\ref{lem:evenB}を$2$つ証明してから，補題\ref{lem:even}を証明して矛盾することを示す．
\begin{lem}[\EvenA] \label{lem:evenA}
  $\forall x, y, n \in \N,$
  $n > 0 \Imp$
  $(\forall i \in \N, ((0 \leq i \leq n) \Imp Cpos(x+i,y,\colorYB(x,n,(x+i)))) \Imp$
  $\forall i \in \N, (0 \leq i \leq n-1 \Imp Cpos(x+i,y+1,red)).$
\end{lem}
補題\ref{lem:evenA}は最上段のマスの色を関数$\colorYB$で塗ると，最上段より$1$つ下の段のマスはすべて赤であるということを表している．
\begin{proof}
  仮定より任意に$i$をとると$0$ $\leq$ $i$ $\leq$ $n-1$であるから，
  $\Cpos(x+i,y,\colorYB(x,n,x))$，$\Cpos(x+i,y,\colorYB(x,n,x+1))$が導ける．
  公理\ref{axm:exists}より$\Cpos(x+i,y+1,c)$となる$c\in\Color$が存在するので，
  存在するこの色に$c$と名前をつけると公理\ref{axm:mix}より$c=\mix(\colorYB(x,n,x+i),\colorYB(x,n,x+i+1))$が成立する．
  \begin{itemize}
  \item
    $i$が偶数のとき \\
    $\colorYB$の定義より，$\colorYB(x,n,x+i)=\blu$，$\colorYB(x,n,x+i+1)=\yel$であるから$c=\red$．
  \item
    $i$が奇数のとき \\
    $\colorYB$の定義より，$\colorYB(x,n,x+i)=\yel$，$\colorYB(x,n,x+i+1)=\blu$であるから$c=\red$．
  \end{itemize}
  よって，$i$の遇奇にかかわらず$c=\red$となるので$\Cpos(x+i,y+1,\red)$．
\end{proof}
\begin{lem}[\EvenB] \label{lem:evenB}
  $\forall x, y, n, \in \N, n > 0 \Imp$
  $\forall i \in \N, ((0 \leq i \leq n) \Imp \Cpos(x+i,y,\colorYB(x,n,x+i))) \Imp \Cpos(x,y+n,\red).$
\end{lem}
補題\ref{lem:evenB}は補題\ref{lem:evenA}より最上段から$1$つ下の段のマスはすべて赤なので，規則に従って色を塗ると最下段のマスの色は赤になるということを表している．
\begin{proof}
  補題\ref{lem:evenB}より$\forall i \in \N, (0 \leq i \leq n-1 \Imp Cpos(x+i,y+1,red))$．
  さらに，補題\ref{lem:AllRed}より$\Cpos(x,y+n,\red)$．
\end{proof}

\begin{lem}[\Even] \label{lem:even}
  $\forall x,y,n \in \N,$ 
  $(n > 0 \land odd(n) = false)$ $\Imp$ 
  $\lnot(\forall c \in \Color, \forall f : \N \to \Color,$ 
  $\WCT(x,y,n,f(x),f(x+n),c)$.
\end{lem}
ただし，補題\ref{lem:even}の中にある$odd(n)$は次のようにSSReflectで定義されている関数である．
\[
odd(n) \eqDef
\begin{cases}
  true & \text{($n$が奇数)} \\
  false & (otherwises)
\end{cases}
\]
\begin{proof}
  公理\ref{axm:paint}より$f=\colorYB$とすると$\Cpos(x,y,\colorYB(x,n,x))$，$\Cpos(x+1,n,\colorYB$ $(x,n,x+n))$．
  このとき，$0$と$n$は偶数であるから$\colorYB(x,n,x)=\colorYB(x,n,x+n)=\yel$．
  公理\ref{axm:exists}より$\Cpos(x,y+n,c)$となる$c\in\Color$が存在するので，
  存在するこの色に$c$と名前をつけると，仮定より$\WCT(x,y,n,\colorYB(x,n,x),\colorYB$ $(x,n,x+n),c)$であるから$c=\yel$．
  一方で，補題\ref{lem:evenB}より$c=\red$となるので補題\ref{lem:falseColor}より
  矛盾が導ける．
\end{proof}

\subsubsection{$n$が奇数 かつ $3^{k} < n \leq 2 \cdot 3^{k}$}
$n$が奇数 かつ$3^{k'} < n \leq 2 \cdot 3^{k}$のときは補題\ref{lem:shortoddA}，\ref{lem:shortoddB}，\ref{lem:shortoddC}を証明してから，補題\ref{lem:shortodd}を証明して矛盾することを示す．
\begin{lem}[\ShortOddA] \label{lem:shortoddA}
  $\forall x,y,n,k \in \N,$
  $(3^k < n \leq (3^k\cdot2) \land odd n = true) \Imp$
  $(\forall x_1,y_1 \in \N, \forall c_0,c_1,c_2 \in \Color, \WCT(x_1,y_1,3^k,c_0,c_1,c_2)) \Imp$
  $(\forall i \in \N, (0 \leq i \leq n) \Imp \Cpos(x+i,y,\colorYBBY(x,n,x+i))) \Imp$
  $(\forall i \in \N, (0 \leq i \leq n - 3^k) \Imp \Cpos(x+i,y+3^k,\colorYB(x,n-3^k,x+i))).$
\end{lem}
補題\ref{lem:shortoddA}は最上段のマスの色を関数$\colorYBBY$で塗ると，最上段より$3^k$下の段のマスは黄，青で交互に塗ってあるということを表している．
\begin{proof}
  仮定より任意に$i$をとると$0$ $\leq$ $i$ $\leq$ $n-3^k$であるから，
  $0 \leq i \leq n$，$0 \leq i+3^k \leq n$を満たすので，
  $\Cpos(x+i,y,\colorYBBY(x,n,x+i))$，$\Cpos(x+i+3^k,y,\colorYBBY(x,n,x+i+3^k))$が導ける．
  公理\ref{axm:exists}より$\Cpos(x+i,y+3^k,c)$となる$c\in\Color$が存在するので，
  存在するこの色に$c$と名前をつける．
  すると，仮定より$\WCT(x,y,n,\colorYBBY(x,n,x+i),$ $\colorYBBY(x,n,x+i+3^k),c)$だから$c=\mix(\colorYBBY(x,n,x+i),\colorYBBY(x,n,x+i+3^k))$が成立する．
  \begin{itemize}
  \item
    $i$が偶数のとき \\
    $\colorYBBY$の定義より，$\colorYBBY(x,n,x+i)=\yel$，$\colorYBBY(x,n,x+i+3^k)=\yel$．
    よって，$\colorYB$の定義より，$c=\yel=\colorYB(x,n-3^k,x+i)$
  \item
    $i$が奇数のとき \\
    $\colorYBBY$の定義より，$\colorYB(x,n,x+i)=\blu$，$\colorYB(x,n,x+i+3^k)=\blu$であるから$c=\blu$．
    よって，$\colorYB$の定義より，$c=\blu=\colorYB(x,n-3^k,x+i)$
  \end{itemize}
  以上より，$i$の遇奇にかかわらず$\colorYBBY(x,n,x+i)=\colorYB(x,n-3^k,x+i)$となるので$\Cpos(x+i,y+3^k,\colorYB(x,n-3^k,x+i))$．
\end{proof}

\begin{lem}[\ShortOddB] \label{lem:shortoddB}
  $\forall x,y,n,k \in \N,$
  $(3^k < n \leq (3^k\cdot2) \land odd n = true) \Imp$
  $(\forall x_1,y_1 \in \N, \forall c_0,c_1,c_2 \in \Color, \WCT(x_1,y_1,3^k,c_0,c_1,c_2)) \Imp$
  $(\forall i \in \N, (0 \leq i \leq n) \Imp \Cpos(x+i,y,\colorYBBY(x,n,x+i))) \Imp$
  $(\forall i \in \N, (0 \leq i \leq n - 3^k-1) \Imp Cpos(x+i,y+3^k+1,red)).$
\end{lem}
補題\ref{lem:shortoddB}は補題\ref{lem:shortoddA}より最上段から$3^k$下の段のマスは黄，青で交互に塗ってあるので，規則に従って色を塗ると最上段から$3^k$下の段より$1$つ下の段のマスはすべて赤であるということを表している．
\begin{proof}
  補題\ref{lem:shortoddA}より$\forall i \in \N, (0 \leq i \leq n - 3^k-1) \Imp Cpos(x+i,y+3^k+1,red)$．
  さらに，補題\ref{lem:AllRed}より$\Cpos(x,y+n,\red)$．
\end{proof}

\begin{lem}[\ShortOddC] \label{lem:shortoddC}
  $\forall x,y,n,k \in \N,$
  $(3^k < n \leq (3^k\cdot2) \land odd n = true) \Imp$
  $(\forall x_1,y_1 \in \N, \forall c_0,c_1,c_2 \in \Color, \WCT(x_1,y_1,3^k,c_0,c_1,c_2)) \Imp$
  $(\forall i \in \N, (0 \leq i \leq n) \Imp \Cpos(x+i,y,\colorYBBY(x,n,x+i))) \Imp$
  $\Cpos(x,y+n,\red).$
\end{lem}
補題\ref{lem:shortoddC}は補題\ref{lem:shortoddB}より最上段から$3^k+1$下の段のマスはすべて赤なので，規則に従って色を塗ると最下段のマスの色は赤になるということを表している．
\begin{proof}
  補題\ref{lem:shortoddB}より$\forall i \in \N, (0 \leq i \leq n - 3^k-1) \Imp Cpos(x+i,y+3^k+1,red)$．
  さらに，補題\ref{lem:AllRed}より$\Cpos(x,y+n,\red)$．
\end{proof}

\begin{lem}[\ShortOdd] \label{lem:shortodd}
  $\forall x,y,n,k \in \N,$
  $(3^k < n \leq (3^k\cdot2) \land odd n = true) \Imp$
  $\lnot(\forall c \in \Color, \forall f:\N \to \Color, \WCT(x,y,n,f(x),f(x+n), c).$
\end{lem}

\subsubsection{$n$が奇数 かつ $2 \cdot 3^{k'} + 1 \leq n < 3^{k+1}$}
$n$が奇数 かつ$2 \cdot 3^{k} + 1 \leq n < 3^{k+1}$のときは補題\ref{lem:longoddA}，\ref{lem:longoddB}，\ref{lem:longoddC}を証明してから，補題\ref{lem:longodd}を証明して矛盾することを示す．
\begin{lem}[\LongOddA] \label{lem:longoddA}
  $\forall k,n,x,y \in \N,$
  $(3.^k\cdot2 + 1 \leq n < 3^{k+1}) \Imp$
  $(\forall x_1,y_1 \in \N, \forall c_0,c_1,c_2 \in \Color, \WCT(x_1,y_1,3^k,c_0,c_1,c_2)) \Imp$
  $(\forall i \in \N,(0 <= i <= n \Imp Cpos(x+i,y,\colorBYB(x,n,k,x+i)))) \Imp$ 
      $($
        $(\forall i \in \N,(0 \leq i \leq n - 3^k\cdot2 \Imp Cpos(x+i,y+3^k,\red)))$
        $land$
        $(\forall i \in \N,(3^k <= i <= n - 3^k \Imp Cpos(x+i,y+3^k,\red)))$
      $)$.
\end{lem}
\begin{lem}[\LongOddB] \label{lem:longoddB}
  $\forall k,n,x,y \in \N,$
  $(3.^k\cdot2 + 1 \leq n < 3^{k+1}) \Imp$
  $(\forall x_1,y_1 \in \N, \forall c_0,c_1,c_2 \in \Color, \WCT(x_1,y_1,3^k,c_0,c_1,c_2)) \Imp$
  $(\forall i \in \N,(0 \leq i \leq n \Imp Cpos(x+i,y,\colorBYB(x,n,k,x+i)))) \Imp$ 
  $\forall i \in \N, (0 \leq i \leq n-(3^k\cdot2) \Imp Cpos(x+i,y+3^k\cdot2,red).$
\end{lem}
\begin{lem}[\LongOddC] \label{lem:longoddC}
  $\forall k,n,x,y \in \N,$
  $(3.^k\cdot2 + 1 \leq n < 3^{k+1}) \Imp$
  $(\forall x_1,y_1 \in \N, \forall c_0,c_1,c_2 \in \Color, \WCT(x_1,y_1,3^k,c_0,c_1,c_2)) \Imp$
  $\Cpos(x,y+n,\red).$
\end{lem}
補題\ref{lem:longoddC}は補題\ref{lem:longoddB}より最上段から$2\cdot3^k$下の段のマスはすべて赤なので，規則に従って色を塗ると最下段のマスの色は赤になるということを表している．
\begin{proof}
  補題\ref{lem:longoddB}より$\forall i \in \N, (0 \leq i \leq n-(3^k\cdot2) \Imp Cpos(x+i,y+3^k\cdot2,red).$
  さらに，補題\ref{lem:AllRed}より$\Cpos(x,y+n,\red)$．
\end{proof}
\begin{lem}[\LongOdd] \label{lem:longodd}
  $\forall x,y,n,k \in \N,$
  $(3^k\cdot2 + 1 \leq n < 3^{k+1}) \Imp$
  $\lnot(\forall c \in \Color, \forall f:\N \to \Color, \WCT(x,y,n,f(x),f(x+n), c).$
\end{lem}
