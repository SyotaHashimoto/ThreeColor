% 三角形三色問題の証明の Coq の実装の準備
\section{ Coq に実装するための準備}
% 3.1 定義
% 関数 \mix・記号の説明
% WellColoredTriangle x y n c0 c1 c2 :=
% Cpos x y c0 /\ Cpos (x+n) y c1 /\ Cpos x (y+n) c2 -> c2 = \mix c0 c1
\subsection{定義}
三角形三色問題のような幾何的な直観に基づく問題や前節で述べたような証明をCoqに実装するには，図形の状況を表現する論理式を用意し，それらを用いて問題の暗黙の前提や色塗り規則などを関数化することで形式化する必要がある．
ここでは実装する際に用いた定義や関数，論理式について述べる．
\begin{dfn}[$\Color$]
  マスに塗る色の集合を次のように定義する．
  \[
  \Color \eqDef \{\red, \yel, \blu\}.
  \]
  このとき，$\red$は{\rm{red}}，$\yel$は{\rm{yellow}}，$\blu$は{\rm{blue}}を表している．
  以降，$\red$を$r$，$\yel$は$y$，$\blu$は$b$として略記することもある．
\end{dfn}
\begin{dfn}[$\mix$]
  $\mix$ $:$ $\Color \to \Color \to \Color$ を以下で定義する．
  \[
  \begin{tabular}{ccccc}
    $(r,r) \Pto r,$ & $(r,y) \Pto b,$ & $(r,b) \Pto y,$ \\
    $(y,r) \Pto b,$ & $(y,y) \Pto y,$ & $(y,b) \Pto r,$ \\
    $(b,r) \Pto y,$ & $(b,y) \Pto r,$ & $(b,b) \Pto b.$ \\
  \end{tabular}
  \]
  演算 $\mix$ は塗り方の規則を再現するための関数の$1$つである．
  引数となる$2$色が同じ場合は同じ色を返し，異なる場合は$2$色とも異なる第三の色を返す関数である．
\end{dfn}
\begin{dfn}[$\cpos$]
  $\cpos$ $:$ $\N \to \N \to \Color$ を
  \begin{center}
  \text{左から} x \text{番目，上から} y \text{段目のマスの色を返す関数}
  \end{center}
  として定義する．
\end{dfn}
\begin{exm}
  図$\ref{fig:nine_steps}$において，逆三角形の$3$つの端点のマスに関して
  次が成立する：
  \begin{itemize}
    \item $\cpos(0,0) = \yel.$
    \item $\cpos(9,0) = \blu.$
    \item $\cpos(0,9) = \red.$
  \end{itemize}
\end{exm}
\begin{dfn}[$\Fmix$]
  $\cpos$ $:$ $\N \to \N \to \Color$ に対して，
  $\Fmix(\cpos)$を次のように定義する．

  
  $\Fmix(\cpos)$ $\iffDef$
  
  $(\forall$ $x,y \in\N,$
  $(\cpos(x,y)$ $=$ $\mix$ $(\cpos(x,y),$ $\cpos(x+1,y)).$

  $\Fmix$は隣接する三角形に配置されたマスの色は調和性を満たしていることを
  論理式に書き直したものである．
  すなわち，逆三角形に塗られている色はランダムに塗られているわけではなく，
  規則に従ってマスの色が塗られた三色三角形であることを表している．
\end{dfn}


\begin{dfn}[$\WCTF$]
  $x, n \in \N$ に対して，
  \WCTF$(x, n)$を次のように定義する．
  
  \WCT$(x, n)$ $\iffDef$
  
  $(\forall$ $\cpos$ $:$ $\N$ $\to$ $\N$ $\to$ $\Color,$
  $(\Fmix(\cpos)$ $\to$ $\TF(\cpos,0,n)).$

  ただし，$\TF(\cpos,0,n))$ は以下で定義されている．
  \[
  \cpos(x,y+n) \eqDef \mix(cpos(x,y),cpos(x+n,y)).
  \]
  $\WCTF$は定義$\ref{dfn:wc_tri}$で述べた$n$段の調和彩色三角形の定義を最上段の色の塗り方の関数$\cpos$を用いて論理式に書き直したものである．
  $x$は逆三角形の左端のマス$(x,0)$
  \footnote
      {
        左から$x$番目，上から$y$段目のマスを座標のように $(x,y)$ と表すことにする．
        すなわち，$(x,0)$は左から$x$番目，上から$0$段目 (最上段) のマスを表している．
      }
  を基準として定めるために用いており，$n$は逆三角形の一辺の長さを表している．
  よって，三角形三色問題におけるマスの塗り方に従っていれば，三色三角形の端点の$3$つのマス$(x,0), (x+n,0), (x,n)$に塗られている色は調和性を満たしていることを表している．
\end{dfn}

% 3.2 証明のための準備
\subsection{彩色条件} \label{sec:paint}
ここからはマスに塗る色の塗り方を表す関数について述べていく．
まず，最初に必要条件で用いる最上段のマスの塗り方を$3$つ紹介する．
\begin{dfn}[$\colorYB$]
  $\colorYB$ $:$ $(\N \times \N \times \N)$ $\to$ $\Color$ を以下で定義する．

  $\colorYB (x,n,z) \eqDef$
  \[
  \begin{cases}
    \yel & (0 \leq z-x \leq n \land z-x\text{が奇数}) \\
    \blu & (0 \leq z-x \leq n \land z-x\text{が偶数}) \\
    \blu & (\text{otherwise})
  \end{cases}
  \]
  $\colorYB$は補題$\ref{lem:tri_nec}$の証明において$n$が偶数のときの最上段のマスの塗り方を表した関数である．
  一番左端にあるマスを基準（左から$x$番目のマス）としたときに，基準から右に$z$番目のマスを指定するときには$z-x$を用いて指定している．
  $z-x$は基準となるマスから離れているマス数を表しており，相対的に最上段のマスを指定している．
  また，$\colorYB$は最上段のマスを交互に塗っていることを$z-x$の偶奇によって定めている．
\end{dfn}
\begin{dfn}[$\colorYBBY$]
  $\colorYBBY$ $:$ $(\N \times \N \times \N)$ $\to$ $\Color$ を以下で定義する．

  $\colorYBBY(x,n,z) \eqDef$
  \[
  \begin{cases}
    \yel & (0 \leq z-x \leq n/2 \land z-x\text{が偶数}) \\
    \yel & (n/2+1 \leq z-x \leq n \land z-x\text{が奇数}) \\
    \blu & (0 \leq z-x \leq n/2 \land z-x\text{が奇数}) \\
    \blu & (n/2+1 \leq z-x \leq n \land z-x\text{が偶数}) \\
    \yel & (\text{otherwise})
  \end{cases}
  \]
  $\colorYBBY$は補題$\ref{lem:tri_nec}$の証明において$n$が奇数 かつ $3^{k} < n \leq 2 \cdot 3^{k}$のときの最上段のマスの塗り方を表した関数である．
  $\colorYB$と同様にして基準となるマスから離れているマス数を用いて相対的に最上段のマスを$1$つ指定している．
  また，$0 \leq z-x \leq n/2$の範囲では左端のマスから偶数番目のときは$\yel$，奇数番目のときは$\blu$を塗り，$n/2+1 \leq z-x \leq n$の範囲では塗る色が入れ替わる．
  このようにして，$\colorYBBY$は外側から内側に向かって対称的に最上段のマスを交互に塗っていることを$z-x$の偶奇によって定めている．
\end{dfn}
\begin{dfn}[$\colorBYB$]
  $\colorBYB$ $:$ $(\N \times \N \times \N \times \N )$ $\to$ $\Color$ を以下で定義する．

  $\colorBYB(x,n,k,z) \eqDef$
  \[
  \begin{cases}
    \yel & (3^k \leq z-x \leq n-3^k) \\
    \blu & (\text{otherwise})
  \end{cases}
  \]
  $\colorBYB$は補題$\ref{lem:tri_nec}$の証明において$n$が奇数かつ$2 \cdot 3^{k'} + 1 \leq n < 3^{k'+1}$のときの最上段のマスの塗り方を表した関数である．
  $\colorYBBY$は基準となるマスから右に$3^k$番目から$n-3^k$番目までマスの色を黄色で塗り，その他を青で塗ることで再現している．
\end{dfn}
ここまで，最上段の色の塗り方を関数で表すことができた．
ここからは最上段のマスの塗り方 (関数) を基にして，
最上段まで色を決めるような関数を定義する．
\begin{dfn}[$\lift$]
  $\lift$ $:$ $color \to \N \to \N \to \Color$ を以下で再帰的関数として定義する．
  ただし，$color$ は型が $\N \to \Color$ の関数である．
  
  $\lift(\colorF,x,y) \eqDef$
  \[
  \begin{cases}
    \colorF(x) \quad (y = 0 \text{のとき}) \\
    \mix(\lift(color,x,y'),\lift(color,x+1,y')) & \\
    \qquad \qquad \qquad \qquad \qquad \qquad \quad (y = y'+1 \text{のとき})
  \end{cases}
  \]
  演算 $\lift$ は塗り方の規則を再現する関数の$1$つである．
  $y=0$ のときは最上段のマスの色は塗り方を表す関数 $\colorF$ で塗っていることを表している．
  また，$y=y'+1$の形をしているときは，最上段から$y'$段目にある隣り合う$2$マスの色に対して，$\mix$を適用することでその間にある$y$段目のマスの色が得られることを表している．
  すなわち，この関数は三角三色問題におけるマスの色の塗り方の規則を表している．
\end{dfn}

% 3.3 補題
% mixCut, AllRed
\subsection{補題} \label{sec:lem}
次に証明を円滑に進めていくために用いた補題について述べる．
\begin{lem}[$\mixCut$] \label{lem:mixCut}
  $\forall c_0, c_1, c_2, c_3 \in Color$に対して，
  $\mix( \mix ( \mix(c_0,c_1) , \mix(c_1,c_2) ), \mix( \mix(c_1,c_2),$\\
  $\mix(c_2,c_3) ) )$ $=$ $\mix(c_0,c_3)$.

  $\mixCut$は演算$\mix$のもつ性質を論理式にしたものであり，$\mix$と$4$色を用いて表された色は$2$色のみを用いて書き換えることができることを表している．
  証明する際には各色が$3$通りずつ取り得るので合計$3^4=81$通りの場合分けをおこなって$\mix$の計算をすれば証明することができる．
  三角形三色問題の十分条件$(\text{補題}\ref{lem:tri_suf})$を証明する際に用いる補題である．
\end{lem}

\begin{lem}[$\AllRed$] \label{lem:AllRed}
  $\forall x, y, n\in \N$ に対して，
  $(\forall i. \in \N,$ $(0 \leq i \leq n$ $\Imp$ $\Cpos(x+i,y,red)))$ $\Imp$ $\Cpos(x,y+n,red)$. 

  三角形三色問題の必要条件$(\text{補題}\ref{lem:tri_nec})$の証明において，$n$がどの場合でもすべてのマスが赤に塗られている段があることに帰着させて矛盾を導いている．
  AllRedにより，すべてのマスが赤で塗られている段があるときは最下段のマスは赤であることを推測できるという補題である．
\end{lem}

